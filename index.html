<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#4CAF50" />
  <title>MapzyVox IA</title>

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icons/icon-192x192.png" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Scripts Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="./js/firebase-config.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f0f0f0;
      text-align: center;
    }
    .splash {
      max-width: 300px;
    }
    /* Estilo para o indicador de carregamento */
    .loading-spinner {
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Estilo para mensagem de erro */
    .error-message {
      color: #f44336;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="splash">
    <h1>MapzyVox IA</h1>
    <p>Carregando aplicação...</p>
    <div class="loading-spinner"></div>
    <p id="error-message" class="error-message">Erro ao carregar a aplicação. <a href="javascript:location.reload()">Tentar novamente</a></p>
  </div>

  <script src="/js/register-sw.js"></script>
  <script>
    // Timeout para garantir que não ficará preso na tela inicial
    const loadTimeout = setTimeout(() => {
      console.log("Timeout de carregamento atingido, redirecionando manualmente");
      document.getElementById('error-message').style.display = 'block';
      document.querySelector('.loading-spinner').style.borderLeftColor = '#f44336';
    }, 10000);
    
    // Função para redirecionar para login
    function redirectToLogin() {
      console.log("Redirecionando para login.html");
      clearTimeout(loadTimeout);
      window.location.href = "login.html";
    }
    
    // Verificar se o Firebase está disponível
    function checkFirebaseAndRedirect() {
      console.log("Verificando disponibilidade do Firebase");
      if (typeof firebase !== 'undefined' && firebase.auth) {
        // Firebase disponível, verificar autenticação
        console.log("Firebase disponível, verificando autenticação");
        firebase.auth().onAuthStateChanged((user) => {
          // Sempre redirecionar para login para resolver o problema de inicialização
          redirectToLogin();
        });
      } else {
        // Firebase não disponível, redirecionar diretamente
        console.log("Firebase não disponível, redirecionando diretamente");
        redirectToLogin();
      }
    }
    
    // Tenta redirecionar quando o service worker estiver pronto ou após um curto timeout
    if ('serviceWorker' in navigator) {
      // Verificar se o service worker está registrado e ativo
      navigator.serviceWorker.getRegistration()
        .then(registration => {
          if (registration && registration.active) {
            console.log("Service Worker ativo encontrado");
            // SW ativo, aguardar um pouco e verificar Firebase
            setTimeout(checkFirebaseAndRedirect, 1000);
          } else {
            console.log("Nenhum Service Worker ativo, usando timeout");
            // Nenhum SW ativo, verificar Firebase após um timeout curto
            setTimeout(checkFirebaseAndRedirect, 2000);
          }
        })
        .catch(error => {
          console.error("Erro ao verificar Service Worker:", error);
          // Erro ao verificar SW, usar timeout
          setTimeout(checkFirebaseAndRedirect, 2000);
        });
    } else {
      // Service Worker não suportado, usar timeout
      console.log("Service Worker não suportado");
      setTimeout(checkFirebaseAndRedirect, 2000);
    }
  </script>
</body>
</html>

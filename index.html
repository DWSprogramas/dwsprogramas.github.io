function checkAuthState(callback) {
  console.log("Verificando estado de autenticação...");

  firebase.auth().onAuthStateChanged((user) => {
    console.log("Estado de autenticação:", user ? "Usuário autenticado" : "Usuário não autenticado");

    const currentPath = window.location.pathname;
    const isLoginPage = currentPath.includes('login.html') || currentPath.endsWith('/login') || currentPath.endsWith('/login.html');

    if (window._isRedirecting) {
      console.log("Redirecionamento já em andamento. Abortando.");
      return;
    }

    // Se o usuário não está autenticado e não está na tela de login
    if (!user && !isLoginPage) {
      window._isRedirecting = true;
      console.log("Redirecionando para a página de login...");
      if (typeof callback === 'function') callback(null); // garante que index não trave
      window.location.replace('./login.html');
      return;
    }

    // Se o usuário está autenticado e está na tela de login
    if (user && isLoginPage) {
      window._isRedirecting = true;
      console.log("Usuário já autenticado. Redirecionando para a página principal...");
      window.location.replace('./index.html');
      return;
    }

    // Se o usuário está autenticado e não está na tela de login
    if (user && !isLoginPage) {
      console.log("Usuário autenticado, permanecendo na página atual.");
      if (typeof callback === 'function') callback(user);
      return;
    }

    // Usuário não autenticado, mas está na tela de login
    if (!user && isLoginPage) {
      console.log("Usuário não autenticado na tela de login.");
      if (typeof callback === 'function') callback(null);
    }
  });
}

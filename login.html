<script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log("Página de login carregada");
      
      // Verificar se já estamos em um fluxo de autenticação
      if (sessionStorage.getItem('authInProgress') === 'true') {
        console.log("Fluxo de autenticação já em andamento, verificando estado...");
        
        // Limpar a flag depois de um tempo para evitar loops infinitos
        setTimeout(() => {
          sessionStorage.removeItem('authInProgress');
        }, 5000);
      }
      
      // Verificar se estamos vindo de um redirecionamento recente
      const lastRedirect = sessionStorage.getItem('lastRedirect');
      const now = Date.now();
      
      if (lastRedirect && (now - parseInt(lastRedirect)) < 2000) {
        console.log("Redirecionamento recente detectado, evitando loop");
        sessionStorage.removeItem('lastRedirect');
        setupLoginButtons(); // Apenas configurar botões, sem verificar autenticação
        return;
      }
      
      // Configurar botões de login primeiro, independente da autenticação
      setupLoginButtons();
      
      // Verificar estado de autenticação
      console.log("Verificando estado de autenticação...");
      if (typeof firebase !== 'undefined' && firebase.auth) {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            console.log("Usuário já autenticado:", user.email);
            
            // Verificar se acabamos de fazer login
            if (sessionStorage.getItem('loginJustCompleted') === 'true') {
              console.log("Login recém-concluído, redirecionando para app.html");
              sessionStorage.removeItem('loginJustCompleted');
              sessionStorage.setItem('lastRedirect', now.toString());
              sessionStorage.setItem('authState', 'authenticated');
              window.location.href = './app.html';
            } else {
              // Verificar se já redirecionamos recentemente
              if (!sessionStorage.getItem('recentLoginRedirect')) {
                console.log("Redirecionando para app.html");
                sessionStorage.setItem('recentLoginRedirect', 'true');
                sessionStorage.setItem('lastRedirect', now.toString());
                
                // Limpar o flag após um período para permitir redirecionamentos futuros
                setTimeout(() => {
                  sessionStorage.removeItem('recentLoginRedirect');
                }, 5000);
                
                window.location.href = './app.html';
              } else {
                console.log("Redirecionamento recente detectado, evitando loop");
                sessionStorage.removeItem('recentLoginRedirect');
              }
            }
          } else {
            console.log("Usuário não autenticado, permanecendo na página de login");
          }
        });
      } else {
        console.error("Firebase não está disponível");
        // Configurar botões mesmo sem Firebase
        setupLoginButtons();
      }
      
      // Função para mostrar mensagens de erro
      function showError(message) {
        // Verifica se já existe um elemento de mensagem
        let messageElement = document.getElementById('message-container');
        if (!messageElement) {
          // Cria o elemento se não existir
          messageElement = document.createElement('div');
          messageElement.id = 'message-container';
          document.body.appendChild(messageElement);
        }
        
        // Limpa qualquer mensagem anterior
        messageElement.innerHTML = '';
        
        // Cria o elemento da nova mensagem
        const msg = document.createElement('div');
        msg.className = 'message message-error';
        msg.textContent = message;
        
        // Adiciona à área de mensagens
        messageElement.appendChild(msg);
        
        // Remove após 4 segundos
        setTimeout(() => {
          msg.classList.add('fade-out');
          setTimeout(() => {
            if (messageElement.contains(msg)) {
              messageElement.removeChild(msg);
            }
          }, 500);
        }, 4000);
      }
      
      // Configuração dos botões de login/cadastro
      function setupLoginButtons() {
        console.log("Configurando botões de login e cadastro");
        
        // Login com email/senha
        const loginButton = document.getElementById('login-button');
        if (loginButton) {
          loginButton.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Verificar se os campos foram preenchidos
            if (!email || !password) {
              showError('Por favor, preencha todos os campos');
              return;
            }
            
            // Mostrar indicador de carregamento
            loginButton.disabled = true;
            const originalContent = loginButton.innerHTML;
            loginButton.innerHTML = '<div class="login-button-spinner"></div> Entrando...';
            
            // Marcar que um login está em andamento
            sessionStorage.setItem('authInProgress', 'true');
            
            // Fazer login
            firebase.auth().signInWithEmailAndPassword(email, password)
              .then((userCredential) => {
                console.log('Login com email bem-sucedido:', userCredential.user.uid);
                // Definir flags para controlar redirecionamento
                sessionStorage.setItem('loginJustCompleted', 'true');
                sessionStorage.setItem('lastRedirect', Date.now().toString());
                sessionStorage.setItem('authState', 'authenticated');
                
                // Redirecionar para a página principal
                window.location.href = './app.html';
              })
              .catch((error) => {
                console.error('Erro de login com email:', error);
                
                // Limpar flag de autenticação em andamento
                sessionStorage.removeItem('authInProgress');
                
                // Restaurar botão
                loginButton.disabled = false;
                loginButton.innerHTML = originalContent;
                
                // Mostrar mensagem de erro apropriada
                let errorMessage = 'Erro ao fazer login. Verifique seu email e senha.';
                
                if (error.code === 'auth/user-not-found') {
                  errorMessage = 'Usuário não encontrado. Verifique seu email ou crie uma conta.';
                } else if (error.code === 'auth/wrong-password') {
                  errorMessage = 'Senha incorreta. Tente novamente.';
                } else if (error.code === 'auth/invalid-email') {
                  errorMessage = 'Email inválido. Verifique o formato do email.';
                } else if (error.code === 'auth/too-many-requests') {
                  errorMessage = 'Muitas tentativas de login. Tente novamente mais tarde.';
                }
                
                // Mostrar mensagem
                showError(errorMessage);
              });
          });
        }
        
        // Login com Google
        const googleButton = document.getElementById('google-login');
        if (googleButton) {
          googleButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Mostrar indicador de carregamento
            googleButton.disabled = true;
            const originalContent = googleButton.innerHTML;
            googleButton.innerHTML = '<div class="login-button-spinner"></div> Conectando...';
            
            // Marcar que um login está em andamento
            sessionStorage.setItem('authInProgress', 'true');
            
            firebase.auth().signInWithPopup(provider)
              .then((result) => {
                // Login bem-sucedido
                const user = result.user;
                console.log('Login com Google bem-sucedido:', user.uid);
                
                // Verificar se é um novo usuário
                const isNewUser = result.additionalUserInfo.isNewUser;
                if (isNewUser) {
                  console.log("Novo usuário detectado, criando dados iniciais");
                  // Criar dados iniciais do usuário
                  createUserData(user.uid);
                }
                
                // Definir flags para controlar redirecionamento
                sessionStorage.setItem('loginJustCompleted', 'true');
                sessionStorage.setItem('lastRedirect', Date.now().toString());
                sessionStorage.setItem('authState', 'authenticated');
                
                // Redirecionar para a página principal
                window.location.href = './app.html';
              })
              .catch((error) => {
                console.error('Erro de login com Google:', error);
                
                // Limpar flag de autenticação em andamento
                sessionStorage.removeItem('authInProgress');
                
                // Restaurar botão
                googleButton.disabled = false;
                googleButton.innerHTML = originalContent;
                
                // Mostrar mensagem de erro
                showError('Erro ao entrar com Google: ' + error.message);
              });
          });
        }
        
        // Registro de novo usuário
        const registerButton = document.getElementById('register-button');
        if (registerButton) {
          registerButton.addEventListener('click', () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-password-confirm').value;
            
            // Verificar se os campos foram preenchidos
            if (!name || !email || !password || !confirmPassword) {
              showError('Por favor, preencha todos os campos');
              return;
            }
            
            // Verificar se as senhas conferem
            if (password !== confirmPassword) {
              showError('As senhas não conferem');
              return;
            }
            
            // Mostrar indicador de carregamento
            registerButton.disabled = true;
            const originalContent = registerButton.innerHTML;
            registerButton.innerHTML = '<div class="login-button-spinner"></div> Registrando...';
            
            // Marcar que um registro está em andamento
            sessionStorage.setItem('authInProgress', 'true');
            
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then((userCredential) => {
                // Conta criada com sucesso
                const user = userCredential.user;
                console.log('Usuário registrado com sucesso:', user.uid);
                
                // Atualizar o perfil do usuário com o nome
                return user.updateProfile({
                  displayName: name
                }).then(() => {
                  // Criar dados iniciais do usuário
                  createUserData(user.uid);
                  
                  // Definir flags para controlar redirecionamento
                  sessionStorage.setItem('loginJustCompleted', 'true');
                  sessionStorage.setItem('lastRedirect', Date.now().toString());
                  sessionStorage.setItem('authState', 'authenticated');
                  
                  // Redirecionar para a página principal
                  window.location.href = './app.html';
                });
              })
              .catch((error) => {
                console.error('Erro ao registrar usuário:', error);
                
                // Limpar flag de autenticação em andamento
                sessionStorage.removeItem('authInProgress');
                
                // Restaurar botão
                registerButton.disabled = false;
                registerButton.innerHTML = originalContent;
                
                // Mostrar mensagem de erro apropriada
                let errorMessage = 'Erro ao criar conta. Tente novamente.';
                
                if (error.code === 'auth/email-already-in-use') {
                  errorMessage = 'Este email já está em uso. Tente fazer login.';
                } else if (error.code === 'auth/invalid-email') {
                  errorMessage = 'Email inválido. Verifique o formato do email.';
                } else if (error.code === 'auth/weak-password') {
                  errorMessage = 'Senha muito fraca. Use pelo menos 6 caracteres.';
                }
                
                // Mostrar mensagem
                showError(errorMessage);
              });
          });
        }
        
        // Esqueceu a senha
        const forgotPasswordLink = document.getElementById('forgot-password');
        if (forgotPasswordLink) {
          forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            if (!email) {
              showError('Por favor, digite seu e-mail');
              return;
            }
            
            firebase.auth().sendPasswordResetEmail(email)
              .then(() => {
                // Mostrar mensagem de sucesso
                alert('Um email de redefinição de senha foi enviado para ' + email);
              })
              .catch((error) => {
                console.error('Erro ao enviar email de redefinição:', error);
                showError('Erro ao enviar email de redefinição: ' + error.message);
              });
          });
        }
        
        // Permitir login pressionando Enter no campo de senha
        const passwordField = document.getElementById('password');
        if (passwordField) {
          passwordField.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
              document.getElementById('login-button').click();
            }
          });
        }
        
        // Permitir registro pressionando Enter no campo de confirmação de senha
        const confirmPasswordField = document.getElementById('reg-password-confirm');
        if (confirmPasswordField) {
          confirmPasswordField.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
              document.getElementById('register-button').click();
            }
          });
        }
      }
      
      // Função para criar dados iniciais do usuário (fallback)
      function createUserData(userId) {
        if (!userId) return Promise.reject(new Error('ID de usuário não fornecido'));
        
        const userData = {
          createdAt: new Date().toISOString(),
          settings: {
            theme: 'light',
            notifications: true
          },
          transcriptions: {
            count: 0
          }
        };
        
        return firebase.database().ref('users/' + userId).set(userData)
          .then(() => {
            console.log('Dados iniciais do usuário criados com sucesso');
            return userData;
          })
          .catch((error) => {
            console.error('Erro ao criar dados iniciais do usuário:', error);
            return null;
          });
      }
    });
  </script>
